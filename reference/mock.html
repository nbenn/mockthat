<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Mock functions in a package. — with_mock • mockthat</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Mock functions in a package. — with_mock" />
<meta property="og:description" content="Mocking allows you to temporary replace the implementation of functions
within a package, which useful for testing code that relies on functions
that are slow, have unintended side effects or access resources that may
not be available when testing.
Up until recently, such capability was offered via testthat::with_mock(),
but with release of version 3.0.0 and introduction of edition 3, this was
deprecated from 'testthat', leaving it to third party packages to replace
this feature. Powered by utils::assignInNamespace(), this mocking
implementation can be used to stub out both exported and non-exported
functions from a package, as well as functions explicitly imported from
other packages using either importFrom directives or namespaced function
calls using ::." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mockthat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/nbenn/mockthat/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Mock functions in a package.</h1>
    <small class="dont-index">Source: <a href='https://github.com/nbenn/mockthat/blob/master/R/mock.R'><code>R/mock.R</code></a></small>
    <div class="hidden name"><code>mock.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Mocking allows you to temporary replace the implementation of functions
within a package, which useful for testing code that relies on functions
that are slow, have unintended side effects or access resources that may
not be available when testing.</p>
<p>Up until recently, such capability was offered via <code><a href='https://testthat.r-lib.org/reference/with_mock.html'>testthat::with_mock()</a></code>,
but with release of version 3.0.0 and introduction of edition 3, this was
deprecated from 'testthat', leaving it to third party packages to replace
this feature. Powered by <code><a href='https://rdrr.io/r/utils/getFromNamespace.html'>utils::assignInNamespace()</a></code>, this mocking
implementation can be used to stub out both exported and non-exported
functions from a package, as well as functions explicitly imported from
other packages using either <code>importFrom</code> directives or namespaced function
calls using <code><a href='https://rdrr.io/r/base/ns-dblcolon.html'>::</a></code>.</p>
    </div>

    <pre class="usage"><span class='fu'>with_mock</span><span class='op'>(</span><span class='va'>...</span>, mock_env <span class='op'>=</span> <span class='fu'>pkg_env</span><span class='op'>(</span><span class='op'>)</span>, eval_env <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sys.parent.html'>parent.frame</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='fu'>local_mock</span><span class='op'>(</span>
  <span class='va'>...</span>,
  mock_env <span class='op'>=</span> <span class='fu'>pkg_env</span><span class='op'>(</span><span class='op'>)</span>,
  eval_env <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/sys.parent.html'>parent.frame</a></span><span class='op'>(</span><span class='op'>)</span>,
  local_env <span class='op'>=</span> <span class='va'>eval_env</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>...</th>
      <td><p>Named parameters redefine mocked functions, unnamed parameters
will be evaluated after mocking the functions.</p></td>
    </tr>
    <tr>
      <th>mock_env</th>
      <td><p>The environment in which to patch the functions,
defaults to either the package namespace when the environment variable
<code>TESTTHAT_PKG</code> is set pr the calling environment. A string is interpreted
as package
name.</p></td>
    </tr>
    <tr>
      <th>eval_env</th>
      <td><p>Environment in which expressions passed as <code>...</code> are
evaluated, defaults to <code><a href='https://rdrr.io/r/base/sys.parent.html'>base::parent.frame()</a></code>.</p></td>
    </tr>
    <tr>
      <th>local_env</th>
      <td><p>Passed to <code><a href='https://withr.r-lib.org/reference/defer.html'>withr::defer()</a></code> as <code>envir</code> argument (defaults
to the values passed as <code>eval_env</code>)</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>The result of the last unnamed argument passed as <code>...</code> (evaluated in the
environment passed as <code>eval_env</code>) in the case of <code>local_mock()</code> and a list
of functions or <code>mock_fun</code> objects (invisibly) for calls to <code>local_mock()</code>.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Borrowing the API from the now-deprecated <code><a href='https://testthat.r-lib.org/reference/with_mock.html'>testthat::with_mock()</a></code>, named
arguments passed as <code>...</code> are used to define functions to be mocked, where
names specify the target functions and the arguments themselves are used as
replacement functions. Unnamed arguments passed as <code>...</code> will be evaluated
in the environment specified as <code>eval_env</code> using the mocked functions. On
exit of <code>with_mock()</code>, the mocked functions are reverted to their original
state.</p>
<p>Replacement functions can either be specified as complete functions, or as
either quoted expressions, subsequently used as function body or objects
used as return values. If functions are created from return values or
complete function bodies, they inherit the signatures from the respective
functions they are used to mock, alongside the ability to keep track of
how they are subsequently called. A constructor for such mock-objects is
available as <code><a href='mock.html'>mock()</a></code>, which quotes the expression passed as <code>expr</code>.</p>
<p>If mocking is desirable for multiple separate calls to the function being
tested, <code>local_mock()</code> is available, which holds onto the mocked state for
the lifetime of the environment passed as <code>local_env</code> using
<code><a href='https://withr.r-lib.org/reference/defer.html'>withr::defer()</a></code>. Unlike <code>with_mock()</code>, which returns the result of
evaluating the last unnamed argument passed as <code>...</code>, <code>local_mock()</code>
(invisibly) returns the functions used for mocking, which if not fully
specified as functions, will be mock-objects described in the previous
paragraph.</p>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='va'>url</span> <span class='op'>&lt;-</span> <span class='st'>"https://eu.httpbin.org/get?foo=123"</span>
<span class='va'>mok</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>...</span><span class='op'>)</span> <span class='st'>"mocked request"</span>

<span class='fu'>with_mock</span><span class='op'>(</span>
  `curl::curl_fetch_memory` <span class='op'>=</span> <span class='va'>mok</span>,
  <span class='fu'>curl</span><span class='fu'>::</span><span class='fu'><a href='https://jeroen.cran.dev/curl/reference/curl_fetch.html'>curl_fetch_memory</a></span><span class='op'>(</span><span class='va'>url</span><span class='op'>)</span>
<span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "mocked request"</div><div class='input'>
<span class='va'>dl_fun</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='fu'>curl</span><span class='fu'>::</span><span class='fu'><a href='https://jeroen.cran.dev/curl/reference/curl_fetch.html'>curl_fetch_memory</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span>

<span class='fu'>with_mock</span><span class='op'>(</span>
  `curl::curl_fetch_memory` <span class='op'>=</span> <span class='va'>mok</span>,
  <span class='fu'>dl_fun</span><span class='op'>(</span><span class='va'>url</span><span class='op'>)</span>
<span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "mocked request"</div><div class='input'>
<span class='va'>json</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>...</span><span class='op'>)</span> <span class='st'>'["mocked request"]'</span>

<span class='fu'>with_mock</span><span class='op'>(</span>
  `curl::curl` <span class='op'>=</span> <span class='va'>json</span>,
  <span class='fu'>jsonlite</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/jsonlite/man/fromJSON.html'>fromJSON</a></span><span class='op'>(</span><span class='va'>url</span><span class='op'>)</span>
<span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "mocked request"</div><div class='input'>
<span class='fu'>with_mock</span><span class='op'>(</span>
  `curl::curl` <span class='op'>=</span> <span class='st'>'["mocked request"]'</span>,
  <span class='fu'>jsonlite</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/jsonlite/man/fromJSON.html'>fromJSON</a></span><span class='op'>(</span><span class='va'>url</span><span class='op'>)</span>
<span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "mocked request"</div><div class='input'>
<span class='fu'>with_mock</span><span class='op'>(</span>
  `curl::curl` <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/substitute.html'>quote</a></span><span class='op'>(</span><span class='op'>{</span>
    <span class='va'>x</span> <span class='op'>&lt;-</span> <span class='st'>"mocked request"</span>
    <span class='fu'><a href='https://rdrr.io/r/base/paste.html'>paste0</a></span><span class='op'>(</span><span class='st'>'["'</span>, <span class='va'>x</span>, <span class='st'>'"]'</span><span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span>,
  <span class='fu'>jsonlite</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/jsonlite/man/fromJSON.html'>fromJSON</a></span><span class='op'>(</span><span class='va'>url</span><span class='op'>)</span>
<span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "mocked request"</div><div class='input'>
<span class='fu'>with_mock</span><span class='op'>(</span>
  `curl::curl` <span class='op'>=</span> <span class='va'>json</span>,
  parse_and_simplify <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>txt</span>, <span class='va'>...</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/grep.html'>gsub</a></span><span class='op'>(</span><span class='st'>'\\[?\\"\\]?'</span>, <span class='st'>""</span>, <span class='va'>txt</span><span class='op'>)</span>,
  <span class='fu'>jsonlite</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/jsonlite/man/fromJSON.html'>fromJSON</a></span><span class='op'>(</span><span class='va'>url</span><span class='op'>)</span>,
  mock_env <span class='op'>=</span> <span class='st'>"jsonlite"</span>
<span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "mocked request"</div><div class='input'>
<span class='va'>dl</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='fu'>curl</span><span class='fu'>::</span><span class='fu'><a href='https://jeroen.cran.dev/curl/reference/curl.html'>curl</a></span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span>

<span class='fu'><a href='https://rdrr.io/r/base/eval.html'>local</a></span><span class='op'>(</span><span class='op'>{</span>
  <span class='va'>mk</span> <span class='op'>&lt;-</span> <span class='fu'>local_mock</span><span class='op'>(</span>`curl::curl` <span class='op'>=</span> <span class='st'>"mocked request"</span><span class='op'>)</span>
  <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span><span class='fu'>dl</span><span class='op'>(</span><span class='va'>url</span><span class='op'>)</span>, <span class='fu'><a href='mock.html'>mock_arg</a></span><span class='op'>(</span><span class='va'>mk</span>, <span class='st'>"url"</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [[1]]
#&gt; [1] "mocked request"
#&gt; 
#&gt; [[2]]
#&gt; [1] "https://eu.httpbin.org/get?foo=123"
#&gt; </div><div class='input'>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Nicolas Bennett.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


