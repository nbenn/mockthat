
test_that("can change value of internal function", {

  with_mock(
    test_mock2 = function() 5,
    expect_equal(test_mock1(), 5)
  )

  # and value is restored on error
  expect_error(
    with_mock(
      test_mock2 = function() 5,
      stop("!")
    )
  )
  expect_equal(test_mock1(), 10)
})


test_that("mocks can access local variables", {

  x <- 5

  with_mock(
    test_mock2 = function() x,
    expect_equal(test_mock1(), 5)
  )
})

test_that("non-empty mock with return value", {

  expect_true(with_mock(
    compare = function(x, y, ...) list(equal = TRUE, message = "TRUE"),
    TRUE
  ))
})

test_that("nested mock", {

  with_mock(
    all.equal = function(x, y, ...) TRUE,
    {
      with_mock(
        expect_warning = expect_error,
        {
          expect_warning(stopifnot(!compare(3, "a")$equal))
        }
      )
    },
    .env = asNamespace("base")
  )

  expect_false(isTRUE(all.equal(3, 5)))
  expect_warning(warning("test"))
})

test_that("can't mock non-existing", {

  expect_error(
    with_mock(..bogus.. = identity, TRUE),
    "Function [.][.]bogus[.][.] not found in environment mockthat"
  )
})

test_that("can't mock non-function", {

  expect_error(
    with_mock(pkg_and_name_rx = FALSE, TRUE),
    "Function pkg_and_name_rx not found in environment mockthat"
  )
})

test_that("empty or no-op mock", {

  warn <- paste("Not mocking anything. Please use named parameters to specify",
                "the functions you want to mock.")

  expect_warning(expect_null(with_mock()), warn, fixed = TRUE)

  expect_warning(expect_true(with_mock(TRUE)), warn, fixed = TRUE)
})

test_that("visibility", {

  expect_warning(
    expect_false(withVisible(with_mock())$visible)
  )

  expect_true(
    withVisible(with_mock(compare = function() {}, TRUE))$visible
  )

  expect_false(
    withVisible(with_mock(compare = function() {}, invisible(5)))$visible
  )
})

test_that("multiple return values", {

  expect_true(with_mock(FALSE, TRUE, compare = function() {}))
  expect_equal(with_mock(3, compare = function() {}, 5), 5)
})

test_that("can access variables defined in function", {

  x <- 5
  expect_equal(with_mock(x, compare = function() {}), 5)
})

test_that("can mock if package is not loaded", {

  if ("package:curl" %in% search()) {
    skip("curl is loaded")
  }

  skip_if_not_installed("curl")

  with_mock(`curl::curl` = identity, expect_identical(curl::curl, identity))
})

test_that(
  "changes to variables are preserved between calls and visible outside", {

  x <- 1

  with_mock(
    test_mock1 = function() {},
    x <- 3,
    expect_equal(x, 3)
  )

  expect_equal(x, 3)
})
